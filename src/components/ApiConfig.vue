<template>
  <div class="api-config">
    <el-card class="config-card">
      <template #header>
        <div class="card-header">
          <span>APIé…ç½®</span>
          <el-tag :type="isApiConfigured ? 'success' : 'danger'" size="small">
            {{ isApiConfigured ? 'å·²é…ç½®' : 'æœªé…ç½®' }}
          </el-tag>
        </div>
      </template>
      
      <!-- é…ç½®ç±»å‹é€‰æ‹© -->
      <div class="config-type-selector">
        <el-radio-group v-model="configType" @change="onConfigTypeChange">
          <el-radio-button label="official">ğŸ¢ 91å†™ä½œå®˜æ–¹API</el-radio-button>
          <el-radio-button label="custom">âš™ï¸ è‡ªå®šä¹‰APIé…ç½®</el-radio-button>
        </el-radio-group>
      </div>

      <!-- ä¸»è¦å†…å®¹åŒºåŸŸ - å·¦å³åˆ†æ  -->
      <div class="config-main-content">
        <!-- å·¦ä¾§ï¼šé…ç½®è¯´æ˜ -->
        <div class="config-tips-panel">
          <!-- å®˜æ–¹é…ç½®è¯´æ˜ -->
          <div v-if="configType === 'official'" class="config-tips official-tips">
            <h4>ğŸ¢ å®˜æ–¹é»˜è®¤é…ç½®</h4>
            <div class="tips-content">
              <p><strong>æ¨èæ–°æ‰‹ä½¿ç”¨</strong>ï¼Œä¸ä¼šè‡ªå·±è·å–APIå’Œé…ç½®å¤§æ¨¡å‹çš„ç”¨æˆ·å¯ä»¥é€‰æ‹©91å†™ä½œå®˜æ–¹æ¨å‡ºçš„ï¼ŒAPIï¼Œåªéœ€è¾“å…¥å¯†é’¥å³å¯ã€‚é‡‡ç”¨<strong>æŒ‰æ¬¡è®¡è´¹</strong>æ¨¡å¼ï¼Œä»·æ ¼é€æ˜ã€‚</p>
              
                             <div class="model-info">
                 <h5>æ¨èæ¨¡å‹ï¼š</h5>
                 <ul>
                   <li><strong>Claude-4 Sonnet</strong> - ï¿¥0.1/æ¬¡ï¼ˆé»˜è®¤ï¼‰</li>
                   <li><strong>Claude Opus 4</strong> - ï¿¥0.5/æ¬¡ï¼ˆé¡¶çº§ï¼‰</li>
                   <li><strong>Claude-3.7 Thinking</strong> - ï¿¥0.2/æ¬¡ï¼ˆæ¨ç†ï¼‰</li>
                   <li><strong>Claude-3.7 Sonnet</strong> - ï¿¥0.1/æ¬¡ï¼ˆç»æµï¼‰</li>
                 </ul>
               </div>
              
               <div class="usage-steps">
                 <h5>ä½¿ç”¨æ­¥éª¤ï¼š</h5>
                 <ol>
                   <li>è¾“å…¥APIå¯†é’¥</li>
                   <li>é€‰æ‹©æ¨¡å‹ï¼ˆæ¨èClaude-4 Sonnetï¼‰</li>
                   <li>ä¿å­˜é…ç½®å³å¯ä½¿ç”¨</li>
                   <li><strong>é—®é¢˜äº¤æµQQç¾¤ï¼š468734087</strong></li>
                 </ol>
               </div>


               <div class="usage-steps">
                 <h5>ä½¿ç”¨æ•™ç¨‹ï¼š</h5>
                 <ol>
                   <li><a href="https://www.bilibili.com/video/BV1keKgzaER2" target="_blank">APIé…ç½®æ•™ç¨‹</a></li>
                   <li><a href="https://www.bilibili.com/video/BV1AYKgzAEne" target="_blank">æœ¬åœ°éƒ¨ç½²åŠçº¿ä¸Šéƒ¨ç½²æ•™ç¨‹</a></li>
                  </ol>
               </div>
              
              <div class="purchase-info">
                <p>è´­ä¹°APIå¯†é’¥</p>
                <el-button type="primary" size="small" @click="openPurchaseLink">
                  å‰å¾€è´­ä¹°
                </el-button>
              </div>
            </div>
          </div>

          <!-- è‡ªå®šä¹‰é…ç½®è¯´æ˜ -->
          <div v-else class="config-tips custom-tips">
            <h4>âš™ï¸ è‡ªå®šä¹‰é…ç½®</h4>
            <div class="tips-content">
              <p><strong>é€‚åˆé«˜çº§ç”¨æˆ·</strong>ï¼Œä»…æ”¯æŒopenaiæ ¼å¼APIã€‚</p>
              
              <div class="params-info">
                <h5>å‚æ•°è¯´æ˜ï¼š</h5>
                <ul>
                  <li><strong>APIåœ°å€</strong> - æ‚¨çš„APIæœåŠ¡åœ°å€</li>
                  <li><strong>APIå¯†é’¥</strong> - èº«ä»½éªŒè¯å¯†é’¥</li>
                  <li><strong>æ¨¡å‹é€‰æ‹©</strong> - å¦‚æœæ²¡æœ‰æƒ³è¦çš„æ¨¡å‹ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¨¡å‹</li>
                  <li><strong>Tokené™åˆ¶</strong> - æ§åˆ¶ç”Ÿæˆé•¿åº¦</li>
                  <li><strong>åˆ›é€ æ€§</strong> - 0ä¿å®ˆï¼Œ1åˆ›æ–°</li>
                </ul>
              </div>
              
              <div class="supported-apis">
                <h5>ç‰¹æ®Šè¯´æ˜ï¼š</h5>
                <ul>
                  <li>openaiæ ¼å¼apiæ˜¯å¤§æ¨¡å‹é€šç”¨æ ¼å¼ï¼Œæ”¯æŒæ‰€æœ‰å¤§æ¨¡å‹</li>
                  <li>æ”¯æŒæœ¬åœ°éƒ¨ç½²å¤§æ¨¡å‹ï¼Œå¦‚ollamaã€llmstudioç­‰ï¼Œè‡ªè¡Œå­¦ä¹ æ€ä¹ˆè·å–openaiæ ¼å¼api</li>
                </ul>
              </div>

              <div class="usage-steps">
                 <h5>ä½¿ç”¨æ•™ç¨‹ï¼š</h5>
                 <ol>
                   <li><a href="https://www.bilibili.com/video/BV1keKgzaER2" target="_blank">APIé…ç½®æ•™ç¨‹</a></li>
                   <li><a href="https://www.bilibili.com/video/BV1AYKgzAEne" target="_blank">æœ¬åœ°éƒ¨ç½²åŠçº¿ä¸Šéƒ¨ç½²æ•™ç¨‹</a></li>
                  </ol>
               </div>
              
              <div class="tips-note">
                <p>ğŸ’¡ å»ºè®®å…ˆæµ‹è¯•è¿æ¥å†ä¿å­˜é…ç½®</p>
              </div>
            </div>
          </div>
        </div>

        <!-- å³ä¾§ï¼šé…ç½®è¡¨å• -->
        <div class="config-form-panel">
          <!-- å®˜æ–¹é»˜è®¤é…ç½® -->
          <div v-if="configType === 'official'" class="official-config">
            <el-alert 
              title="å®˜æ–¹é»˜è®¤é…ç½®" 
              type="info" 
              :closable="false"
              show-icon
            >
              <template #default>
                ä½¿ç”¨å®˜æ–¹æ¨èçš„APIæœåŠ¡ï¼Œç¨³å®šå¯é ã€‚
              </template>
            </el-alert>
            
            <el-form :model="officialForm" label-width="80px" size="small" class="config-form">
              <el-form-item label="APIå¯†é’¥" required>
                <el-input
                  v-model="officialForm.apiKey"
                  type="password"
                  placeholder="è¯·è¾“å…¥APIå¯†é’¥"
                  show-password
                  clearable
                />
              </el-form-item>
              
              <el-form-item label="APIåœ°å€">
                <el-input
                  v-model="officialForm.baseURL"
                  placeholder="å®˜æ–¹APIåœ°å€"
                  :disabled="true"
                />
                <div class="form-tip">å®˜æ–¹ä¼˜åŒ–åœ°å€ï¼Œæ— éœ€ä¿®æ”¹</div>
              </el-form-item>
              
              <el-form-item label="æ¨èæ¨¡å‹">
                <el-select v-model="officialForm.selectedModel" placeholder="é€‰æ‹©æ¨èæ¨¡å‹">
                  <el-option
                    v-for="model in officialModels"
                    :key="model.id"
                    :label="model.name"
                    :value="model.id"
                  >
                    <div class="model-option">
                      <span class="model-name">{{ model.name }}</span>
                      <span class="model-price">{{ model.price }}</span>
                    </div>
                    <div class="model-description">{{ model.description }}</div>
                  </el-option>
                </el-select>
              </el-form-item>
              
              <el-form-item label="æœ€å¤§Token">
                <div class="max-tokens-control">
                  <el-checkbox v-model="officialForm.unlimitedTokens" @change="handleOfficialUnlimitedTokensChange">
                    æ— é™åˆ¶Token
                  </el-checkbox>
                  <el-input-number
                    v-if="!officialForm.unlimitedTokens"
                    v-model="officialForm.maxTokens"
                    :min="1"
                    :max="10000000"
                    :step="1000"
                    style="width: 100%"
                  />
                </div>
              </el-form-item>
              
              <el-form-item label="åˆ›é€ æ€§">
                <el-slider
                  v-model="officialForm.temperature"
                  :min="0"
                  :max="1"
                  :step="0.1"
                  :format-tooltip="formatTemperature"
                  show-tooltip
                />
              </el-form-item>
              
              <el-form-item>
                <el-button type="primary" @click="saveOfficialConfig" :loading="validating">
                  {{ validating ? 'éªŒè¯ä¸­...' : 'ä¿å­˜é…ç½®' }}
                </el-button>
                <el-button @click="testOfficialConnection" :loading="validating">
                  æµ‹è¯•è¿æ¥
                </el-button>
              </el-form-item>
            </el-form>
          </div>

          <!-- è‡ªå®šä¹‰é…ç½® -->
          <div v-else class="custom-config">
            <el-alert 
              title="è‡ªå®šä¹‰é…ç½®" 
              type="warning" 
              :closable="false"
              show-icon
            >
              <template #default>
                é«˜çº§ç”¨æˆ·å¯è‡ªå®šä¹‰APIåœ°å€å’Œæ¨¡å‹å‚æ•°ã€‚
              </template>
            </el-alert>
            
            <el-form :model="customForm" label-width="80px" size="small" class="config-form">
              <el-form-item label="APIå¯†é’¥" required>
                <el-input
                  v-model="customForm.apiKey"
                  type="password"
                  placeholder="è¯·è¾“å…¥APIå¯†é’¥"
                  show-password
                  clearable
                />
              </el-form-item>
              
              <el-form-item label="APIåœ°å€" required>
                <el-input
                  v-model="customForm.baseURL"
                  placeholder="https://api.openai.com/v1"
                  clearable
                />
              </el-form-item>
              
              <el-form-item label="æ¨¡å‹é€‰æ‹©">
                <el-select 
                  v-model="customForm.selectedModel" 
                  placeholder="é€‰æ‹©æ¨¡å‹"
                  filterable
                  allow-create
                >
                  <el-option
                    v-for="model in availableModels"
                    :key="model.id"
                    :label="model.name"
                    :value="model.id"
                  >
                    <span>{{ model.name }}</span>
                    <span style="float: right; color: #8492a6; font-size: 12px">
                      {{ model.description }}
                    </span>
                  </el-option>
                </el-select>
              </el-form-item>
              
              <el-form-item label="è‡ªå®šä¹‰æ¨¡å‹">
                <div class="custom-model-input">
                  <el-input
                    v-model="customModelInput"
                    placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°"
                    @keyup.enter="addCustomModel"
                  />
                  <el-button @click="addCustomModel" type="primary" size="small">æ·»åŠ </el-button>
                </div>
                <div v-if="customModels.length > 0" class="custom-models-list">
                  <el-tag
                    v-for="model in customModels"
                    :key="model.id"
                    closable
                    @close="removeCustomModel(model.id)"
                    size="small"
                    style="margin-right: 8px; margin-bottom: 4px;"
                  >
                    {{ model.name }}
                  </el-tag>
                </div>
              </el-form-item>
              
              <el-form-item label="æœ€å¤§Token">
                <div class="max-tokens-control">
                  <el-checkbox v-model="customForm.unlimitedTokens" @change="handleCustomUnlimitedTokensChange">
                    æ— é™åˆ¶Token
                  </el-checkbox>
                  <el-input-number
                    v-if="!customForm.unlimitedTokens"
                    v-model="customForm.maxTokens"
                    :min="1"
                    :max="10000000"
                    :step="1000"
                    style="width: 100%"
                  />
                </div>
              </el-form-item>
              
              <el-form-item label="åˆ›é€ æ€§">
                <el-slider
                  v-model="customForm.temperature"
                  :min="0"
                  :max="1"
                  :step="0.1"
                  :format-tooltip="formatTemperature"
                  show-tooltip
                />
              </el-form-item>
              
              <el-form-item>
                <el-button type="primary" @click="saveCustomConfig" :loading="validating">
                  {{ validating ? 'éªŒè¯ä¸­...' : 'ä¿å­˜é…ç½®' }}
                </el-button>
                <el-button @click="testCustomConnection" :loading="validating">
                  æµ‹è¯•è¿æ¥
                </el-button>
                <el-button @click="resetCustomConfig">é‡ç½®</el-button>
              </el-form-item>
            </el-form>
          </div>
        </div>
      </div>
    </el-card>
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted } from 'vue'
import { ElMessage } from 'element-plus'
import { useNovelStore } from '../stores/novel.js'
import apiService from '../services/api.js'

const store = useNovelStore()
const validating = ref(false)
const customModelInput = ref('')
const customModels = ref([])
const configType = ref('official') // 'official' æˆ– 'custom'

// å®˜æ–¹é»˜è®¤é…ç½®
const officialForm = reactive({
  apiKey: '',
  baseURL: 'https://ai.91hub.vip/v1',
  selectedModel: 'claude-4-sonnet',
  maxTokens: 2000000,
  unlimitedTokens: false,
  temperature: 0.7
})

// è‡ªå®šä¹‰é…ç½®
const customForm = reactive({
  apiKey: '',
  baseURL: 'https://api.openai.com/v1',
  selectedModel: 'gpt-3.5-turbo',
  maxTokens: 2000000,
  unlimitedTokens: false,
  temperature: 0.7
})

// å®˜æ–¹æ¨èæ¨¡å‹ï¼ˆå¸¦ä»·æ ¼ï¼‰
const officialModels = [
  {
    id: 'claude-4-sonnet',
    name: 'Claude-4 Sonnet',
    description: 'æœ€æ–°ä¸€ä»£Claudeæ¨¡å‹ï¼Œæ“…é•¿åˆ›æ„å†™ä½œå’Œé•¿æ–‡æœ¬å¤„ç†',
    price: 'ï¿¥0.1/æ¬¡'
  },
  {
    id: 'claude-opus-4-20250514',
    name: 'Claude Opus 4',
    description: 'æœ€å¼ºæ€§èƒ½Claudeæ¨¡å‹ï¼Œé¡¶çº§åˆ›ä½œèƒ½åŠ›',
    price: 'ï¿¥0.5/æ¬¡'
  },
  {
    id: 'claude-3-7-sonnet-thinking',
    name: 'Claude-3.7 Sonnet Thinking',
    description: 'å…·å¤‡æ€ç»´é“¾çš„Claudeæ¨¡å‹ï¼Œé€»è¾‘æ¨ç†å¼º',
    price: 'ï¿¥0.2/æ¬¡'
  },
  {
    id: 'claude-3-7-sonnet-20250219',
    name: 'Claude-3.7 Sonnet',
    description: 'é«˜æ€§èƒ½ç‰ˆæœ¬ï¼Œå¹³è¡¡æ€§èƒ½ä¸æˆæœ¬',
    price: 'ï¿¥0.1/æ¬¡'
  }
]

// è‡ªå®šä¹‰é…ç½®å¯é€‰æ¨¡å‹
const defaultModels = [
  {
    id: 'deepseek-reasoner',
    name: 'deepseek-r1',
    description: 'deepseek-r1'
  },
  {
    id: 'deepseek-chat',
    name: 'deepseek-v3',
    description: 'deepseek-v3'
  },
  {
    id: 'claude-3.7-sonnet',
    name: 'claude-3.7-sonnet',
    description: 'claude-3.7-sonnet'
  },
  {
    id: 'claude-4-sonnet',
    name: 'claude-4-sonnet',
    description: 'claude-4-sonnet'
  },
  {
    id: 'gemini-2.5-pro-preview-05-06',
    name: 'gemini-2.5-pro-preview-05-06',
    description: 'gemini-2.5-pro-preview-05-06'
  }
]

const availableModels = computed(() => {
  return [...defaultModels, ...customModels.value]
})

const isApiConfigured = computed(() => store.isApiConfigured)

const formatTemperature = (value) => {
  if (value <= 0.3) return 'ä¿å®ˆ'
  if (value <= 0.7) return 'å¹³è¡¡'
  return 'åˆ›æ–°'
}

// æ‰“å¼€è´­ä¹°é“¾æ¥
const openPurchaseLink = () => {
  window.open('https://item.taobao.com/item.htm?ft=t&id=938261705242', '_blank')
}

// é…ç½®ç±»å‹åˆ‡æ¢
const onConfigTypeChange = (type) => {
  configType.value = type
  // æ ¹æ®é…ç½®ç±»å‹æ›´æ–°storeä¸­çš„é…ç½®
  const currentForm = type === 'official' ? officialForm : customForm
  store.updateApiConfig(currentForm, type)
  store.switchConfigType(type)
}

// å®˜æ–¹é…ç½®ç›¸å…³æ–¹æ³•
const handleOfficialUnlimitedTokensChange = () => {
  if (officialForm.unlimitedTokens) {
    officialForm.maxTokens = null
  } else {
    officialForm.maxTokens = 2000000
  }
}

const saveOfficialConfig = async () => {
  if (!officialForm.apiKey) {
    ElMessage.warning('è¯·è¾“å…¥APIå¯†é’¥')
    return
  }
  
  // ç¡®ä¿å®˜æ–¹é…ç½®å§‹ç»ˆä½¿ç”¨æ­£ç¡®çš„APIåœ°å€
  officialForm.baseURL = 'https://ai.91hub.vip/v1'
  
  validating.value = true
  try {
    // ä½¿ç”¨æ–°çš„store APIï¼ŒæŒ‡å®šé…ç½®ç±»å‹ä¸ºå®˜æ–¹é…ç½®
    store.updateApiConfig(officialForm, 'official')
    store.switchConfigType('official')
    const isValid = await store.validateApiKey()
    
    if (isValid) {
      ElMessage.success('å®˜æ–¹é…ç½®ä¿å­˜æˆåŠŸ')
      localStorage.setItem('officialApiConfig', JSON.stringify(officialForm))
    } else {
      ElMessage.error('APIå¯†é’¥éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®')
    }
  } catch (error) {
    ElMessage.error('é…ç½®ä¿å­˜å¤±è´¥ï¼š' + error.message)
  } finally {
    validating.value = false
  }
}

const testOfficialConnection = async () => {
  if (!officialForm.apiKey) {
    ElMessage.warning('è¯·å…ˆè¾“å…¥APIå¯†é’¥')
    return
  }
  
  // ç¡®ä¿å®˜æ–¹é…ç½®å§‹ç»ˆä½¿ç”¨æ­£ç¡®çš„APIåœ°å€
  officialForm.baseURL = 'https://ai.91hub.vip/v1'
  
  validating.value = true
  try {
    // ä½¿ç”¨æ–°çš„store APIè¿›è¡Œæµ‹è¯•
    store.updateApiConfig(officialForm, 'official')
    store.switchConfigType('official')
    const isValid = await store.validateApiKey()
    
    if (isValid) {
      ElMessage.success('å®˜æ–¹é…ç½®è¿æ¥æµ‹è¯•æˆåŠŸ')
    } else {
      ElMessage.error('è¿æ¥æµ‹è¯•å¤±è´¥')
    }
  } catch (error) {
    ElMessage.error('è¿æ¥æµ‹è¯•å¤±è´¥ï¼š' + error.message)
  } finally {
    validating.value = false
  }
}

// è‡ªå®šä¹‰é…ç½®ç›¸å…³æ–¹æ³•
const handleCustomUnlimitedTokensChange = () => {
  if (customForm.unlimitedTokens) {
    customForm.maxTokens = null
  } else {
    customForm.maxTokens = 2000000
  }
}

const addCustomModel = () => {
  const modelName = customModelInput.value.trim()
  if (!modelName) return
  
  const exists = availableModels.value.some(model => model.id === modelName)
  if (exists) {
    ElMessage.warning('è¯¥æ¨¡å‹å·²å­˜åœ¨')
    return
  }
  
  customModels.value.push({
    id: modelName,
    name: modelName,
    description: 'è‡ªå®šä¹‰æ¨¡å‹'
  })
  
  customModelInput.value = ''
  ElMessage.success('è‡ªå®šä¹‰æ¨¡å‹æ·»åŠ æˆåŠŸ')
  saveCustomModels()
}

const removeCustomModel = (modelId) => {
  const index = customModels.value.findIndex(model => model.id === modelId)
  if (index > -1) {
    customModels.value.splice(index, 1)
    
    if (customForm.selectedModel === modelId) {
      customForm.selectedModel = 'gpt-3.5-turbo'
    }
    
    ElMessage.success('è‡ªå®šä¹‰æ¨¡å‹åˆ é™¤æˆåŠŸ')
    saveCustomModels()
  }
}

const saveCustomModels = () => {
  localStorage.setItem('customModels', JSON.stringify(customModels.value))
}

const loadCustomModels = () => {
  const saved = localStorage.getItem('customModels')
  if (saved) {
    try {
      customModels.value = JSON.parse(saved)
    } catch (error) {
      console.error('åŠ è½½è‡ªå®šä¹‰æ¨¡å‹å¤±è´¥:', error)
    }
  }
}

const saveCustomConfig = async () => {
  if (!customForm.apiKey) {
    ElMessage.warning('è¯·è¾“å…¥APIå¯†é’¥')
    return
  }
  
  validating.value = true
  try {
    // ä½¿ç”¨æ–°çš„store APIï¼ŒæŒ‡å®šé…ç½®ç±»å‹ä¸ºè‡ªå®šä¹‰é…ç½®
    store.updateApiConfig(customForm, 'custom')
    store.switchConfigType('custom')
    const isValid = await store.validateApiKey()
    
    if (isValid) {
      ElMessage.success('è‡ªå®šä¹‰é…ç½®ä¿å­˜æˆåŠŸ')
      localStorage.setItem('customApiConfig', JSON.stringify(customForm))
    } else {
      ElMessage.error('APIå¯†é’¥éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®')
    }
  } catch (error) {
    ElMessage.error('é…ç½®ä¿å­˜å¤±è´¥ï¼š' + error.message)
  } finally {
    validating.value = false
  }
}

const testCustomConnection = async () => {
  if (!customForm.apiKey) {
    ElMessage.warning('è¯·å…ˆè¾“å…¥APIå¯†é’¥')
    return
  }
  
  validating.value = true
  try {
    // ä½¿ç”¨æ–°çš„store APIè¿›è¡Œæµ‹è¯•
    store.updateApiConfig(customForm, 'custom')
    store.switchConfigType('custom')
    const isValid = await store.validateApiKey()
    
    if (isValid) {
      ElMessage.success('è‡ªå®šä¹‰é…ç½®è¿æ¥æµ‹è¯•æˆåŠŸ')
    } else {
      ElMessage.error('è¿æ¥æµ‹è¯•å¤±è´¥')
    }
  } catch (error) {
    ElMessage.error('è¿æ¥æµ‹è¯•å¤±è´¥ï¼š' + error.message)
  } finally {
    validating.value = false
  }
}

const resetCustomConfig = () => {
  Object.assign(customForm, {
    apiKey: '',
    baseURL: 'https://api.openai.com/v1',
    selectedModel: 'gpt-3.5-turbo',
    maxTokens: 2000000,
    unlimitedTokens: false,
    temperature: 0.7
  })
  localStorage.removeItem('customApiConfig')
  ElMessage.success('è‡ªå®šä¹‰é…ç½®å·²é‡ç½®')
}

// åŠ è½½ä¿å­˜çš„é…ç½®
const loadSavedConfig = () => {
  // åŠ è½½é…ç½®ç±»å‹
  const savedType = localStorage.getItem('apiConfigType') || 'official'
  configType.value = savedType
  
  // åŠ è½½å®˜æ–¹é…ç½® - åªå…è®¸åŠ è½½APIå¯†é’¥ï¼Œå…¶ä»–å‚æ•°ä¿æŒé»˜è®¤å€¼
  const savedOfficial = localStorage.getItem('officialApiConfig')
  if (savedOfficial) {
    try {
      const config = JSON.parse(savedOfficial)
      // å®˜æ–¹é…ç½®åªå…è®¸è¦†ç›–APIå¯†é’¥ï¼Œå…¶ä»–å‚æ•°ï¼ˆç‰¹åˆ«æ˜¯baseURLï¼‰ä¿æŒé»˜è®¤å€¼
      if (config.apiKey) {
        officialForm.apiKey = config.apiKey
      }
      // å…¶ä»–å‚æ•°å¯ä»¥è¦†ç›–ï¼Œä½†baseURLå¿…é¡»ä¿æŒå®˜æ–¹åœ°å€
      if (config.selectedModel) {
        officialForm.selectedModel = config.selectedModel
      }
      if (config.maxTokens !== undefined) {
        officialForm.maxTokens = config.maxTokens
      }
      if (config.unlimitedTokens !== undefined) {
        officialForm.unlimitedTokens = config.unlimitedTokens
      } else if (config.maxTokens === null) {
        officialForm.unlimitedTokens = true
      }
      if (config.temperature !== undefined) {
        officialForm.temperature = config.temperature
      }
      // å¼ºåˆ¶ä¿æŒå®˜æ–¹APIåœ°å€ï¼Œä¸å…è®¸è¢«è¦†ç›–
      officialForm.baseURL = 'https://ai.91hub.vip/v1'
    } catch (error) {
      console.error('åŠ è½½å®˜æ–¹é…ç½®å¤±è´¥:', error)
    }
  }
  
  // åŠ è½½è‡ªå®šä¹‰é…ç½® - å®Œå…¨ç‹¬ç«‹çš„æ•°æ®æº
  const savedCustom = localStorage.getItem('customApiConfig')
  if (savedCustom) {
    try {
      const config = JSON.parse(savedCustom)
      if (config.unlimitedTokens === undefined) {
        config.unlimitedTokens = config.maxTokens === null
      }
      Object.assign(customForm, config)
    } catch (error) {
      console.error('åŠ è½½è‡ªå®šä¹‰é…ç½®å¤±è´¥:', error)
    }
  }
  
  // åº”ç”¨å½“å‰é…ç½®ç±»å‹çš„é…ç½®åˆ°store
  const currentForm = configType.value === 'official' ? officialForm : customForm
  store.updateApiConfig(currentForm, configType.value)
  store.switchConfigType(configType.value)
}

onMounted(() => {
  loadCustomModels()
  loadSavedConfig()
})
</script>

<style scoped>
.api-config {
  padding: 20px;
  max-width: 100%;
}

.config-card {
  max-width: 1600px;
  margin: 0 auto;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.config-type-selector {
  margin-bottom: 20px;
  text-align: center;
}

/* ä¸»è¦å†…å®¹åŒºåŸŸ - å·¦å³åˆ†æ å¸ƒå±€ */
.config-main-content {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 32px;
  align-items: start;
}

/* å·¦ä¾§é…ç½®è¯´æ˜é¢æ¿ */
.config-tips-panel {
  min-height: 400px;
}

.config-tips {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 20px;
  height: 100%;
}

.config-tips.official-tips {
  background: #e8f4fd;
  border-color: #b3d9f7;
}

.config-tips.custom-tips {
  background: #fef4e8;
  border-color: #f7d9b3;
}

.config-tips h4 {
  margin: 0 0 12px 0;
  color: #2c3e50;
  font-size: 16px;
  font-weight: 600;
}

.config-tips h5 {
  margin: 16px 0 8px 0;
  color: #34495e;
  font-size: 14px;
  font-weight: 600;
}

.tips-content p {
  margin: 0 0 12px 0;
  color: #5a6c7d;
  line-height: 1.5;
}

.tips-content ul,
.tips-content ol {
  margin: 8px 0;
  padding-left: 20px;
}

.tips-content li {
  margin-bottom: 4px;
  color: #5a6c7d;
  line-height: 1.4;
  font-size: 13px;
}

.purchase-info {
  margin-top: 16px;
  padding: 12px;
  background: white;
  border: 1px solid #ddd;
  border-radius: 6px;
  text-align: center;
}

.purchase-info p {
  margin: 0 0 8px 0;
  font-size: 13px;
}

.tips-note {
  margin-top: 16px;
  padding: 8px 12px;
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 4px;
}

.tips-note p {
  margin: 0;
  font-size: 12px;
  color: #856404;
}

/* å³ä¾§é…ç½®è¡¨å•é¢æ¿ */
.config-form-panel {
  min-height: 400px;
}

.config-form {
  margin-top: 16px;
  padding: 0 8px;
}

.model-option {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.model-name {
  font-weight: 500;
}

.model-price {
  color: #F56C6C;
  font-size: 12px;
  font-weight: 600;
}

.model-description {
  color: #909399;
  font-size: 12px;
  margin-top: 2px;
}

.form-tip {
  font-size: 12px;
  color: #909399;
  margin-top: 4px;
}

.custom-model-input {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}

.custom-models-list {
  margin-top: 8px;
}

.max-tokens-control {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* å“åº”å¼å¸ƒå±€ */
@media (max-width: 900px) {
  .config-main-content {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .config-tips-panel,
  .config-form-panel {
    min-height: auto;
  }
  
  .config-card {
    max-width: 100%;
  }
}

@media (max-width: 1200px) and (min-width: 901px) {
  .config-main-content {
    grid-template-columns: 1fr 1fr;
    gap: 24px;
  }
}

:deep(.el-form-item__label) {
  font-weight: 500;
}

:deep(.el-slider__runway) {
  margin: 16px 0;
}

:deep(.el-radio-button__inner) {
  padding: 10px 20px;
  font-weight: 500;
}

:deep(.el-alert) {
  margin-bottom: 16px;
}

.official-config, .custom-config {
  min-height: 350px;
}
</style>